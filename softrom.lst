    1               ; **********************************************
    2               ; ************* SoftROM EEPROM tool ************
    3               ; **********************************************
    4               ;
    5               ; Assemble with "The Black Smurf Assembler"
    6               ; freely available from https://github.com/Edilbert/BSA
    7               ;
    8               ; Copyright (c) 2014 Nils Eilers <nils.eilers@gmx.de>
    9               ; This work is free. You can redistribute it and/or modify it under the
   10               ; terms of the Do What The Fuck You Want to Public License, Version 2,
   11               ; as published by Sam Hocevar. See the COPYING file for more details.
   12               
   13               ; ************
   14               ; * Keycodes *
   15               ; ************
   16               
   17 000d          CR         =  13     ; Carriage Return
   18 0013          HOME       =  19     ; Home
   19 0014          DEL        =  20     ; Delete
   20 0093          CLR        = 147     ; Clear
   21               
   22               ; ****************
   23               ; * Screen codes *
   24               ; ****************
   25               
   26 0000          C8296 = 0
   27               
   28 0001 FALSE    #if C8296
   29 SKIP          HOR_BAR    = 102     ; -
   30 SKIP          VER_BAR    =  97     ; |
   31 SKIP          UL         = 104     ; upper left
   32 SKIP          UR         = 106     ; upper right
   33 SKIP          LL         =  98     ; lower left
   34 SKIP          LR         = 100     ; lower right
   35 SKIP          TL         = 101     ; T left
   36 SKIP          TR         = 103     ; T right
   37 SKIP          TU         = 105     ; T upper
   38 SKIP          TB         =  99     ; T bottom
   39 SKIP          
   40               #else
   41               
   42 0040          HOR_BAR    =  64     ; -
   43 005d          VER_BAR    =  93     ; |
   44 0070          UL         = 112     ; upper left
   45 006e          UR         = 110     ; upper right
   46 006d          LL         = 109     ; lower left
   47 007d          LR         = 125     ; lower right
   48 006b          TL         = 107     ; T left
   49 0073          TR         = 115     ; T right
   50               #endif
   51               
   52 0050          COLUMNS    =  80     ; CBM 8000 series
   53 0019          ROWS       =  25
   54               
   55 004d          Tracks     =  77     ; Tracks per side
   56               
   57               ; ****************************
   58               ; * Some Zero Page Variables *
   59               ; ****************************
   60               
   61 0016          BP        = $16      ; Buffer Pointer
   62 0018          STP       = $18      ; String Pointer
   63 001a          TEMP      = $1a      ; Miscellenious
   64 001b          SP        = $1b      ; SCREEN Pointer
   65 00d1          FNLEN     = $d1      ; Length of Filename
   66 00d3          SA        = $d3      ; Secondary Address
   67 00d4          FA        = $d4      ; First Address
   68 00da          FNADR     = $da      ; Pointer to Filename
   69               
   70               ; ************************
   71               ; * CBM Kernal Variables *
   72               ; ************************
   73               
   74 0096          STATUS    = $96      ; Status byte
   75 009b          STKEY     = $9b      ; Stop key pressed?
   76 00a7          BLNSW     = $a7      ; Blink switch
   77 00a8          BLNCT     = $a8      ; Blink count
   78 00aa          BLNON     = $aa      ; Blink On
   79 00d4          FA        = $d4
   80               
   81               ; ********************************
   82               ; * Location for status messages *
   83               ; ********************************
   84               
   85 8000          Screen = $8000
   86               
   87               ; *****************************************
   88               ; * Put the buffer after the program code *
   89               ; *****************************************
   90               
   91 0900          Buffer  = [EOP & $ff00] + $100
   92 0008          PosDiskName =  8
   93 001a          PosDiskID   = 26
   94               
   95               ; ***************************************************
   96               ; * The CBM 8000 Kernal has no jump table for these *
   97               ; ***************************************************
   98               
   99 f0d2          TALK    = $f0d2
  100 f0d5          LISTEN  = $f0d5
  101 f143          SECOND  = $f143
  102 f193          TKSA    = $f193
  103 f19e          CIOUT   = $f19e
  104 f1ae          UNTLK   = $f1ae
  105 f1b9          UNLSN   = $f1b9
  106 f1c0          ACPTR   = $f1c0
  107 ffd2          BSOUT   = $ffd2
  108 ffe4          GETIN   = $ffe4
  109               
  110               ; ***************
  111               ; * Print Macro *
  112               ; ***************
  113               
  114               MACRO MAC_Print(lab)
  115                         LDY #<lab
  116                         LDA #>lab
  117                         LDX #?lab
  118                         JSR PrintText
  119               ENDMAC
  120               
  121               MACRO MAC_Plot(Row,Col,Char)
  122                         LDA #Char
  123                         LDX #Row
  124                         LDY #Col
  125                         JSR PlotAt
  126               ENDMAC 
  127               
  128               MACRO MAC_PutString(Row,Col,Text)
  129                         LDX #Row
  130                         LDY #Col
  131                         JSR GotoXY
  132                         LDX #<Text
  133                         LDY #>Text
  134                         JSR PutString
  135               ENDMAC
  136               
  137               ; **********************************
  138               ; * BASIC header for program start *
  139               ; **********************************
  140               
  141 0401          START   = $0401
  142               
  143 0401          * = START ; *** BASIC ***  CBM / PET series
  144               
  146 0401                  .STORE START,EOP-START,"softrom.prg"
  147               
  148 0401 27 04    Link      .WORD EndLink
  149               
  150               ; **********
  151 0403            Linenumber
  152               ; **********
  153               
  154 0403 de 07              .WORD 2014 
  155               
  156               ; **********
  157 0405            SysCommand
  158               ; **********
  159               
  160 0405 9e                 .BYTE $9e       ; SYS token 
  161 0406 28 31 30 StartML   .BYTE "(1065)"
  162 040c 3a 8f              .BYTE ':',$8f   ; REM token
  163 040e 20 53 4f           .BYTE " SOFTROM EEPROM TOOL 0.0"
  164 0426 00       LineEnd   .BYTE 0 
  165 0427 00 00    EndLink   .WORD 0
  166               
  167 0429 4c 9d 06           JMP Main
  168               
  169 042c 30 30 30 NUMBER    .BYTE "00000 "
  170 0432 55 4e 49 UnitText  .BYTE 'unit:',0
  171 0438 44 52 49 DriveText .BYTE 'drive:',0
  172 043f 24 30    Dir_Name  .BYTE "$0"
  173 0441 50       Cols      .BYTE 80
  174 0442 00       CursorRow .BYTE  0
  175 0443 00       CursorCol .BYTE  0
  176 0444 00       Entries   .BYTE  0
  177 0445 02       Pages     .BYTE  2
  178 0446 00 00 00 ScreenLo  .FILL 25 (0) ; 25 bytes
  179 045f 00 00 00 ScreenHi  .FILL 25 (0) ; 25 bytes
  180 0478 00 00 00 EntryLo   .FILL 42 (0) ; 42 bytes
  181 04a2 00 00 00 EntryHi   .FILL 42 (0) ; 42 bytes
  182 04cc 00       Page      .BYTE  0
  183 04cd 00       Offset    .BYTE  0
  184 04ce 08       Unit      .BYTE  8
  185 04cf 30       Drive     .BYTE  '0'
  186 04d0 00       LV0       .BYTE  0
  187 04d1 00       LV1       .BYTE  0
  188 04d2 00 00    EOD       .WORD  0  ; End Of Directory
  189               
  190 8079          Disk_Status = $8000 + 121
  191               
  192               
  193               ; ****
  194 04d4            STOP
  195               ; ****
  196 04d4 a5 9b              LDA STKEY
  197 04d6 c9 ef              CMP #$ef
  198 04d8 60                 RTS
  199               
  200               ; **********
  201 04d9            Error_Beep
  202               ; **********
  203               
  204 04d9 a9 07              LDA #7
  205 04db 4c d2 ff           JMP BSOUT
  206               
  207               ; *********
  208 04de            PrintText
  209               ; *********
  210               
  211 04de 84 1b              STY SP
  212 04e0 85 1c              STA SP+1
  213 04e2 a0 00              LDY #0
  214 04e4 b1 1b    PrTe_10   LDA (SP),Y
  215 04e6 20 d2 ff           JSR BSOUT
  216 04e9 c8                 INY
  217 04ea ca                 DEX
  218 04eb d0 f7              BNE PrTe_10
  219 04ed 60                 RTS
  220               
  221               ; ********************
  222 04ee            Flush_Keyboard_Queue
  223               ; ********************
  224               
  225 04ee 20 e4 ff           JSR GETIN
  226 04f1 d0 fb              BNE Flush_Keyboard_Queue
  227 04f3 60                 RTS  
  228               
  229               ; ***********
  230 04f4            FormatByte
  231               ; ***********
  232               
  233               ; Convert binary number in (A) to
  234               ; three decimal digits in (Y),(X) and (A)
  235               
  236 04f4 a0 30              LDY #'0'      ; 100
  237 04f6 a2 2f              LDX #'0'-1    ;  10
  238 04f8 38                 SEC  
  239 04f9 e8       asts_01   INX  
  240 04fa e9 0a              SBC #10
  241 04fc b0 fb              BCS asts_01
  242 04fe 69 3a              ADC #$3a 
  243 0500 e0 3a              CPX #$3a 
  244 0502 90 07              BCC asts_rt  ; X < 10
  245 0504 48                 PHA  
  246 0505 8a                 TXA  
  247 0506 e9 0a              SBC #10      ; X -= 10
  248 0508 aa                 TAX  
  249 0509 68                 PLA  
  250 050a c8                 INY          ; Y = 1
  251 050b 60       asts_rt   RTS  
  252               
  253               
  254               ; **************
  255 050c            FormatInteger
  256               ; **************
  257               
  258 050c a0 2f              LDY #$2f           ; X = low  byte
  259 050e 38                 SEC                ; A = high byte
  260 050f c8       FORINT_01 INY
  261 0510 8e d0 04           STX LV0
  262 0513 8d d1 04           STA LV1
  263 0516 8a                 TXA  
  264 0517 e9 10              SBC #<10000
  265 0519 aa                 TAX  
  266 051a ad d1 04           LDA LV1
  267 051d e9 27              SBC #>10000
  268 051f b0 ee              BCS FORINT_01
  269 0521 8c 2c 04           STY NUMBER
  270 0524 ae d0 04           LDX LV0
  271 0527 ad d1 04           LDA LV1
  272 052a a0 2f              LDY #$2f 
  273 052c 38                 SEC  
  274 052d c8       FORINT_02 INY
  275 052e 8e d0 04           STX LV0
  276 0531 8d d1 04           STA LV1
  277 0534 8a                 TXA  
  278 0535 e9 e8              SBC #<1000
  279 0537 aa                 TAX  
  280 0538 ad d1 04           LDA LV1
  281 053b e9 03              SBC #>1000
  282 053d b0 ee              BCS FORINT_02
  283 053f 8c 2d 04           STY NUMBER+1
  284 0542 ae d0 04           LDX LV0
  285 0545 ad d1 04           LDA LV1
  286 0548 a0 2f              LDY #$2f 
  287 054a 38                 SEC  
  288 054b c8       FORINT_03 INY
  289 054c 8e d0 04           STX LV0
  290 054f 8d d1 04           STA LV1
  291 0552 8a                 TXA  
  292 0553 e9 64              SBC #100 
  293 0555 aa                 TAX  
  294 0556 ad d1 04           LDA LV1
  295 0559 e9 00              SBC #0
  296 055b b0 ee              BCS FORINT_03
  297 055d 8c 2e 04           STY NUMBER+2
  298 0560 ad d0 04           LDA LV0
  299 0563 a0 2f              LDY #$2f 
  300 0565 38                 SEC  
  301 0566 c8       FORINT_04 INY
  302 0567 e9 0a              SBC #10
  303 0569 b0 fb              BCS FORINT_04
  304 056b 8c 2f 04           STY NUMBER+3
  305 056e 69 3a              ADC #$3a 
  306 0570 8d 30 04           STA NUMBER+4
  307 0573 a2 00              LDX #0
  308 0575 a9 20              LDA #' ' 
  309 0577 bc 2c 04 FORINT_05 LDY NUMBER,X
  310 057a c0 30              CPY #'0' 
  311 057c d0 08              BNE FORINT_06
  312 057e 9d 2c 04           STA NUMBER,X
  313 0581 e8                 INX  
  314 0582 e0 04              CPX #4
  315 0584 90 f1              BCC FORINT_05
  316 0586 60       FORINT_06 RTS
  317               
  318               
  319               ; ********
  320 0587            ShowUnit
  321               ; ********
  322               
  323 0587 a2 01              LDX #1
  324 0589 a0 06              LDY #6
  325 058b 20 62 07           JSR GotoXY
  326 058e ad ce 04           LDA Unit
  327 0591 20 f4 04           JSR FormatByte
  328 0594 e0 30              CPX #'0'
  329 0596 f0 06              BEQ ShUn10
  330 0598 48                 PHA
  331 0599 8a                 TXA
  332 059a 20 69 07           JSR PutChar
  333 059d 68                 PLA
  334 059e 20 69 07 ShUn10    JSR PutChar
  335 05a1 a9 20              LDA #' '
  336 05a3 4c 69 07           JMP PutChar
  337                         
  338               ; *********
  339 05a6            ShowDrive
  340               ; *********
  341               
  342 05a6 ad cf 04           LDA Drive
  343 05a9 a2 01              LDX #1
  344 05ab a0 0f              LDY #15
  345 05ad 4c ad 07           JMP PlotAt
  346               
  347               
  348               ; ************
  349 05b0            ShowDiskName
  350               ; ************
  351               
  352 05b0 a2 01              LDX #1
  353 05b2 a0 12              LDY #18
  354 05b4 20 62 07           JSR GotoXY
  355 05b7 a9 20              LDA #' '
  356 05b9 8d 18 09           STA Buffer + PosDiskName + 16 ; delete quote
  357 05bc a9 00              LDA #0
  358 05be 8d 1c 09           STA Buffer + PosDiskName + 20 ; mark string end
  359 05c1 a2 08              LDX #<[Buffer + PosDiskName]
  360 05c3 a0 09              LDY #>[Buffer + PosDiskName]
  361 05c5 4c 89 07           JMP PutString
  362               
  363               ; **************
  364 05c8            FormatFilename
  365               ; **************
  366               
  367 05c8 a5 16              LDA BP
  368 05ca 85 18              STA STP
  369 05cc a5 17              LDA BP+1
  370 05ce 85 19              STA STP+1
  371 05d0 a0 02              LDY #2
  372 05d2 b1 16              LDA (BP),Y      ; Blocks low
  373 05d4 aa                 TAX
  374 05d5 c8                 INY
  375 05d6 b1 16              LDA (BP),Y      ; Blocks high
  376 05d8 20 0c 05           JSR FormatInteger
  377 05db a0 00              LDY #0
  378 05dd b9 2e 04 FoFi10    LDA NUMBER+2,Y
  379 05e0 91 16              STA (BP),Y
  380 05e2 c8                 INY
  381 05e3 c0 04              CPY #4
  382 05e5 90 f6              BCC FoFi10
  383 05e7 b1 16              LDA (BP),Y
  384 05e9 c9 20              CMP #' '
  385 05eb d0 1c              BNE FoFi99
  386 05ed e6 18    FoFi20    INC STP
  387 05ef b1 18              LDA (STP),Y
  388 05f1 c9 20              CMP #' '
  389 05f3 f0 f8              BEQ FoFi20
  390 05f5 c9 22              CMP #$22
  391 05f7 f0 f4              BEQ FoFi20
  392 05f9 91 16              STA (BP),Y
  393 05fb c8       FoFi40    INY
  394 05fc c0 20              CPY #$20
  395 05fe b0 09              BCS FoFi99
  396 0600 b1 18    FoFi50    LDA (STP),Y
  397 0602 91 16              STA (BP),Y
  398 0604 d0 f5              BNE FoFi40
  399 0606 ee 44 04           INC Entries
  400 0609 60       FoFi99    RTS
  401                         
  402               
  403               ; *************
  404 060a            FormatEntries
  405               ; *************
  406               
  407 060a a9 00              LDA #0
  408 060c 8d 44 04           STA Entries
  409 060f a9 20              LDA #$20        ; 1st. file
  410 0611 85 16              STA BP
  411 0613 a9 09              LDA #>Buffer
  412 0615 85 17              STA BP+1
  413 0617 a0 04    FoEn10    LDY #4          ; after link and #
  414 0619 b1 16              LDA (BP),Y
  415 061b c9 20              CMP #' '        ; for filename must be blank
  416 061d d0 1a              BNE FoEn99
  417 061f 20 c8 05           JSR FormatFilename
  418 0622 18                 CLC
  419 0623 a5 16              LDA BP
  420 0625 69 20              ADC #$20
  421 0627 85 16              STA BP
  422 0629 90 02              BCC FoEn20
  423 062b e6 17              INC BP+1
  424 062d ad d2 04 FoEn20    LDA EOD         ; check for End Of Directory
  425 0630 c5 16              CMP BP
  426 0632 ad d3 04           LDA EOD+1
  427 0635 e5 17              SBC BP+1
  428 0637 b0 de              BCS FoEn10         
  429 0639 60       FoEn99    RTS
  430               
  431               
  432               ; *******
  433 063a            PET2SCR
  434               ; *******
  435               
  436 063a c9 41              CMP #$41
  437 063c 90 11              BCC P2C99
  438 063e c9 5b              CMP #$5b
  439 0640 b0 03              BCS P2C10
  440 0642 29 1f              AND #$1f    ; a - z
  441 0644 60                 RTS
  442 0645 c9 c1    P2C10     CMP #$c1
  443 0647 90 06              BCC P2C99
  444 0649 c9 ca              CMP #$ca
  445 064b b0 02              BCS P2C99
  446 064d 29 7f              AND #$7f    ; A - Z
  447 064f 60       P2C99     RTS
  448               
  449               ; *********
  450 0650            ShowEntry
  451               ; *********
  452               
  453 0650 bd 78 04           LDA EntryLo,X
  454 0653 85 1b              STA SP
  455 0655 bd a2 04           LDA EntryHi,X
  456 0658 85 1c              STA SP+1
  457 065a a0 00              LDY #0
  458 065c b1 16    ShEn10    LDA (BP),Y
  459 065e f0 10              BEQ ShEn99
  460 0660 c9 22              CMP #$22            ; hide quote
  461 0662 d0 02              BNE ShEn20
  462 0664 a9 20              LDA #' '
  463 0666 20 3a 06 ShEn20    JSR PET2SCR
  464 0669 91 1b              STA (SP),Y
  465 066b c8                 INY
  466 066c c0 20              CPY #32
  467 066e 90 ec              BCC ShEn10
  468 0670 60       ShEn99    RTS
  469               
  470               
  471               ; ***********
  472 0671            ShowEntries
  473               ; ***********
  474               
  475 0671 a9 20              LDA #<[Buffer + $20]
  476 0673 85 16              STA BP
  477 0675 a9 09              LDA #>[Buffer + $20]
  478 0677 85 17              STA BP+1
  479 0679 a2 00              LDX #0
  480 067b 20 50 06 ShoE10    JSR ShowEntry
  481 067e 18                 CLC
  482 067f a5 16              LDA BP
  483 0681 69 20              ADC #$20
  484 0683 85 16              STA BP
  485 0685 90 02              BCC ShoE20
  486 0687 e6 17              INC BP+1
  487 0689 e8       ShoE20    INX
  488 068a ec 44 04           CPX Entries
  489 068d b0 04              BCS ShoE99
  490 068f e0 2a              CPX #42
  491 0691 90 e8              BCC ShoE10
  492 0693 60       ShoE99    RTS
  493               
  494               
  495               ; ********
  496 0694            MainLoop
  497               ; ********
  498               
  499 0694 20 d4 04           JSR STOP
  500 0697 f0 03              BEQ MaLo99
  501 0699 4c 94 06           JMP MainLoop
  502 069c 60       MaLo99    RTS
  503               
  504               ; ****
  505 069d            Main
  506               ; ****
  507               
  508 069d 20 db 06           JSR Detect_BASIC_version
  509 06a0 20 dc 06           JSR Detect_Screen_Width
  510 06a3 20 e7 06           JSR SetupScreen
  511 06a6 20 04 07           JSR SetupEntries
  512 06a9 20 12 08           JSR PaintMask
  513 06ac a9 00              LDA #0
  514 06ae 8d 44 04           STA Entries
  515 06b1 a9 08              LDA #8
  516 06b3 8d ce 04           STA Unit
  517 06b6 a9 30              LDA #'0'
  518 06b8 8d cf 04           STA Drive
  519 06bb 20 87 08           JSR Load_Directory
  520 06be 20 87 05           JSR ShowUnit
  521 06c1 20 a6 05           JSR ShowDrive
  522 06c4 20 b0 05           JSR ShowDiskName
  523 06c7 20 0a 06           JSR FormatEntries
  524 06ca 20 71 06           JSR ShowEntries
  525 06cd 20 94 06           JSR MainLoop
  526 06d0 a0 15              LDY #21
  527 06d2 a9 0d              LDA #13
  528 06d4 20 d2 ff Main10    JSR BSOUT
  529 06d7 88                 DEY
  530 06d8 d0 fa              BNE Main10
  531 06da 60       EXIT      RTS
  532               
  533               
  534               
  535               ; ********************
  536 06db            Detect_BASIC_version
  537               ; ********************
  538               ; TODO: detect BASIC version and patch vectors
  539 06db 60                 RTS
  540               
  541               ; *******************
  542 06dc            Detect_Screen_Width
  543               ; *******************
  544               ; TODO: detect Screen Width
  545 06dc a9 50              LDA #80
  546 06de 8d 41 04           STA Cols
  547 06e1 a9 02              LDA #2
  548 06e3 8d 45 04           STA Pages
  549 06e6 60                 RTS
  550               
  551               
  552               ; ***********
  553 06e7            SetupScreen
  554               ; ***********
  555               
  556 06e7 a9 00              LDA #<Screen
  557 06e9 a2 80              LDX #>Screen
  558 06eb a0 00              LDY #0
  559 06ed 99 46 04 SeSe10    STA ScreenLo,Y
  560 06f0 8a                 TXA
  561 06f1 99 5f 04           STA ScreenHi,Y
  562 06f4 18                 CLC
  563 06f5 b9 46 04           LDA ScreenLo,Y
  564 06f8 6d 41 04           ADC Cols
  565 06fb 90 01              BCC SeSe20
  566 06fd e8                 INX
  567 06fe c8       SeSe20    INY
  568 06ff c0 19              CPY #ROWS
  569 0701 90 ea              BCC SeSe10
  570 0703 60                 RTS
  571               
  572               
  573               ; ************
  574 0704            SetupEntries
  575               ; ************
  576               
  577 0704 a0 00              LDY #0
  578 0706 b9 49 04 SeEn10    LDA ScreenLo+3,Y
  579 0709 be 62 04           LDX ScreenHi+3,Y
  580 070c 09 01              ORA #1
  581 070e 99 78 04           STA EntryLo,Y
  582 0711 48                 PHA
  583 0712 8a                 TXA
  584 0713 99 a2 04           STA EntryHi,Y
  585 0716 68                 PLA
  586 0717 18                 CLC
  587 0718 69 28              ADC #40
  588 071a 99 8d 04           STA EntryLo+21,Y
  589 071d 90 01              BCC SeEn20
  590 071f e8                 INX
  591 0720 8a       SeEn20    TXA
  592 0721 99 b7 04           STA EntryHi+21,Y
  593 0724 c8                 INY
  594 0725 c0 15              CPY #21
  595 0727 90 dd              BCC SeEn10
  596 0729 60                 RTS
  597               
  598               
  599               ; ********
  600 072a            Hor_Line
  601               ; ********
  602               
  603 072a 18                CLC
  604 072b b9 46 04          LDA ScreenLo,Y   ; Row # (0-24) in Y
  605 072e 6d cd 04          ADC Offset
  606 0731 85 1b             STA SP
  607 0733 b9 5f 04          LDA ScreenHi,Y
  608 0736 69 00             ADC #0
  609 0738 85 1c             STA SP+1
  610 073a a0 01             LDY #1
  611 073c a9 40             LDA #HOR_BAR
  612 073e 91 1b    HoLi10   STA (SP),Y
  613 0740 c8                INY
  614 0741 c0 27             CPY #39
  615 0743 90 f9             BCC HoLi10
  616 0745 60                RTS
  617               
  618               ; ********
  619 0746            Ver_Line
  620               ; ********
  621               
  622 0746 18                CLC
  623 0747 98                TYA
  624 0748 6d cd 04          ADC Offset
  625 074b a8                TAY
  626 074c a2 01             LDX #1           ; Col # (0-39) in Y
  627 074e bd 46 04 VeLi10   LDA ScreenLo,X
  628 0751 85 1b             STA SP
  629 0753 bd 5f 04          LDA ScreenHi,X
  630 0756 85 1c             STA SP+1
  631 0758 a9 5d             LDA #VER_BAR
  632 075a 91 1b             STA (SP),Y
  633 075c e8                INX
  634 075d e0 18             CPX #24
  635 075f 90 ed             BCC VeLi10
  636 0761 60                RTS
  637               
  638               
  639               ; ******
  640 0762            GotoXY
  641               ; ******
  642               
  643 0762 8e 42 04           STX CursorRow
  644 0765 8c 43 04           STY CursorCol
  645 0768 60                 RTS
  646               
  647               ; *******
  648 0769            PutChar
  649               ; *******
  650               
  651 0769 48                 PHA                ; A = Char
  652 076a ae 42 04           LDX CursorRow
  653 076d 18                 CLC
  654 076e bd 46 04           LDA ScreenLo,X
  655 0771 6d 43 04           ADC CursorCol
  656 0774 85 1b              STA SP
  657 0776 bd 5f 04           LDA ScreenHi,X
  658 0779 69 00              ADC #0
  659 077b 85 1c              STA SP+1
  660 077d 68                 PLA
  661 077e a0 00              LDY #0
  662 0780 91 1b              STA (SP),Y
  663 0782 20 3a 06           JSR PET2SCR
  664 0785 ee 43 04           INC CursorCol
  665 0788 60                 RTS
  666               
  667               
  668               ; *********
  669 0789            PutString
  670               ; *********
  671               
  672 0789 86 18              STX STP
  673 078b 84 19              STY STP+1
  674 078d a0 00              LDY #0
  675 078f b1 18              LDA (STP),Y
  676 0791 f0 19              BEQ PuSt99
  677 0793 20 3a 06           JSR PET2SCR
  678 0796 20 69 07           JSR PutChar
  679 0799 c8       PuSt10    INY
  680 079a c0 28              CPY #40
  681 079c b0 0e              BCS PuSt99      ; safety exit
  682 079e b1 18              LDA (STP),Y
  683 07a0 f0 0a              BEQ PuSt99
  684 07a2 20 3a 06           JSR PET2SCR
  685 07a5 91 1b              STA (SP),Y
  686 07a7 ee 43 04           INC CursorCol
  687 07aa d0 ed              BNE PuSt10
  688 07ac 60       PuSt99    RTS
  689               
  690               ; ******
  691 07ad            PlotAt
  692               ; ******
  693               
  694 07ad 48                PHA              ; X = Row
  695 07ae 18                CLC              ; Y = Col
  696 07af 98                TYA              ; A = Char
  697 07b0 6d cd 04          ADC Offset
  698 07b3 a8                TAY
  699 07b4 bd 46 04          LDA ScreenLo,X
  700 07b7 85 1b             STA SP
  701 07b9 bd 5f 04          LDA ScreenHi,X
  702 07bc 85 1c             STA SP+1
  703 07be 68                PLA
  704 07bf 91 1b             STA (SP),Y
  705 07c1 60                RTS
  706               
  707               ; **********
  708 07c2            PaintPage
  709               ; **********
  710               
  711 07c2 a0 00              LDY #0
  712 07c4 20 2a 07           JSR Hor_Line
  713 07c7 a0 02              LDY #2
  714 07c9 20 2a 07           JSR Hor_Line
  715 07cc a0 18              LDY #24
  716 07ce 20 2a 07           JSR Hor_Line
  717 07d1 a0 00              LDY #0
  718 07d3 20 46 07           JSR Ver_Line
  719 07d6 a0 27              LDY #39
  720 07d8 20 46 07           JSR Ver_Line
  721                         MAC_Plot( 0, 0,UL)
  721 07db a9 70              LDA #UL
  721 07dd a2 00              LDX #0
  721 07df a0 00              LDY #0
  721 07e1 20 ad 07           JSR PlotAt
  721               
  722                         MAC_Plot( 0,39,UR)
  722 07e4 a9 6e              LDA #UR
  722 07e6 a2 00              LDX #0
  722 07e8 a0 27              LDY #39
  722 07ea 20 ad 07           JSR PlotAt
  722               
  723                         MAC_Plot(24, 0,LL)
  723 07ed a9 6d              LDA #LL
  723 07ef a2 18              LDX #24
  723 07f1 a0 00              LDY #0
  723 07f3 20 ad 07           JSR PlotAt
  723               
  724                         MAC_Plot(24,39,LR)
  724 07f6 a9 7d              LDA #LR
  724 07f8 a2 18              LDX #24
  724 07fa a0 27              LDY #39
  724 07fc 20 ad 07           JSR PlotAt
  724               
  725                         MAC_Plot( 2, 0,TL)
  725 07ff a9 6b              LDA #TL
  725 0801 a2 02              LDX #2
  725 0803 a0 00              LDY #0
  725 0805 20 ad 07           JSR PlotAt
  725               
  726                         MAC_Plot( 2,39,TR)
  726 0808 a9 73              LDA #TR
  726 080a a2 02              LDX #2
  726 080c a0 27              LDY #39
  726 080e 20 ad 07           JSR PlotAt
  726               
  727 0811 60                 RTS
  728               
  729               ; **********
  730 0812            PaintMask
  731               ; **********
  732               
  733 0812 a9 8e              LDA #142         ; Screen Mode
  734 0814 20 d2 ff           JSR BSOUT
  735 0817 a9 93              LDA #CLR
  736 0819 20 d2 ff           JSR BSOUT        ; clear screen
  737 081c 20 d2 ff           JSR BSOUT        ; amd remove window settings
  738 081f a9 0e              LDA #14
  739 0821 8d 4c e8           STA $e84c        ; text char set
  740 0824 ad 45 04           LDA Pages
  741 0827 8d cc 04           STA Page
  742 082a a9 00              LDA #0
  743 082c 8d cd 04           STA Offset
  744 082f 20 c2 07 PaMa10    JSR PaintPage
  745 0832 18                 CLC
  746 0833 ad cd 04           LDA Offset
  747 0836 69 28              ADC #40
  748 0838 8d cd 04           STA Offset
  749 083b ce cc 04           DEC Page
  750 083e d0 ef              BNE PaMa10
  751 0840 a9 00              LDA #0
  752 0842 8d cd 04           STA Offset
  753                         MAC_PutString(1,1,UnitText)
  753 0845 a2 01              LDX #1
  753 0847 a0 01              LDY #1
  753 0849 20 62 07           JSR GotoXY
  753 084c a2 32              LDX #<UnitText
  753 084e a0 04              LDY #>UnitText
  753 0850 20 89 07           JSR PutString
  753               
  754                         MAC_PutString(1,9,DriveText)
  754 0853 a2 01              LDX #1
  754 0855 a0 09              LDY #9
  754 0857 20 62 07           JSR GotoXY
  754 085a a2 38              LDX #<DriveText
  754 085c a0 04              LDY #>DriveText
  754 085e 20 89 07           JSR PutString
  754               
  755 0861 60                 RTS
  756               
  757               
  758               
  759               ; *****************
  760 0862            Get_Disk_Status
  761               ; *****************
  762               
  763 0862 ad ce 04           LDA Unit
  764 0865 85 d4              STA FA
  765 0867 20 d2 f0           JSR TALK 
  766 086a a9 6f              LDA #$6f 
  767 086c 20 93 f1           JSR TKSA 
  768 086f a0 00              LDY #0
  769 0871 20 c0 f1 gss_10    JSR ACPTR
  770 0874 c9 20              CMP #' ' 
  771 0876 90 0b              BCC gss_20
  772 0878 20 3a 06           JSR PET2SCR
  773 087b 99 79 80           STA Disk_Status,Y
  774 087e c8                 INY  
  775 087f c0 28              CPY #40
  776 0881 90 ee              BCC gss_10
  777 0883 20 ae f1 gss_20    JSR UNTLK
  778 0886 60                 RTS  
  779               
  780               
  781               ; **************
  782 0887            Load_Directory
  783               ; **************
  784               
  785 0887 a9 00              LDA #<Buffer        ; Initialize buffer pointer BP
  786 0889 85 16              STA BP              ; and End Of Directory EOD
  787 088b 8d d2 04           STA EOD
  788 088e a9 09              LDA #>Buffer
  789 0890 85 17              STA BP+1
  790 0892 8d d3 04           STA EOD+1
  791 0895 ad ce 04           LDA Unit            ; Send LOAD "$n" to Unit
  792 0898 85 d4              STA FA
  793 089a 20 d5 f0           JSR LISTEN
  794 089d a9 f0              LDA #$f0
  795 089f 20 43 f1           JSR SECOND
  796 08a2 a9 24              LDA #'$'
  797 08a4 20 9e f1           JSR CIOUT
  798 08a7 ad cf 04           LDA Drive
  799 08aa 20 9e f1           JSR CIOUT
  800 08ad 20 b9 f1           JSR UNLSN
  801 08b0 20 62 08           JSR Get_Disk_Status
  802 08b3 ad 79 80           LDA Disk_Status
  803 08b6 c9 30              CMP #'0'
  804 08b8 d0 2b              BNE LoDi99
  805 08ba 20 d2 f0           JSR TALK
  806 08bd a9 60              LDA #$60
  807 08bf 20 93 f1           JSR TKSA
  808 08c2 a9 bd              LDA #$bd
  809 08c4 25 96              AND STATUS
  810 08c6 85 96              STA STATUS
  811 08c8 a0 00              LDY #0
  812 08ca 20 c0 f1 LoDi10    JSR ACPTR
  813 08cd 91 16              STA (BP),Y
  814 08cf 24 96              BIT STATUS
  815 08d1 70 07              BVS LoDi20
  816 08d3 c8                 INY
  817 08d4 d0 f4              BNE LoDi10
  818 08d6 e6 17              INC BP+1
  819 08d8 10 f0              BPL LoDi10
  820 08da 20 ae f1 LoDi20    JSR UNTLK
  821 08dd 8c d2 04           STY EOD
  822 08e0 a5 17              LDA BP+1
  823 08e2 8d d3 04           STA EOD+1
  824 08e5 60       LoDi99    RTS
  825               
  826 08e6          EOP       ; END-OF-PROGRAM
  827               


  145 Symbols
-------------
C8296                          $0000    26D    28 
PosDiskName                    $0008    92D   356    358    359    360 
CR                             $000d    17D
HOME                           $0013    18D
DEL                            $0014    19D
BP                             $0016    61D   367    369    372y   375y
                                       379y   383y   392y   397y   410 
                                       412    414y   419    421    423 
                                       425    427    458y   476    478 
                                       482    484    486    786    789 
                                       813y   818    822 
STP                            $0018    62D   368    370    386    387y
                                       396y   672    673    675y   682y
ROWS                           $0019    53D   568 
PosDiskID                      $001a    93D
TEMP                           $001a    63D
SP                             $001b    64D   211    212    214y   454 
                                       456    464y   606    609    612y
                                       628    630    632y   656    659 
                                       662y   685y   700    702    704y
HOR_BAR                        $0040    42D   611 
Tracks                         $004d    55D
COLUMNS                        $0050    52D
VER_BAR                        $005d    43D   631 
TL                             $006b    48D   725 
LL                             $006d    46D   723 
UR                             $006e    45D   722 
UL                             $0070    44D   721 
TR                             $0073    49D   726 
LR                             $007d    47D   724 
CLR                            $0093    20D   735 
STATUS                         $0096    74D   809    810    814 
STKEY                          $009b    75D   196 
BLNSW                          $00a7    76D
BLNCT                          $00a8    77D
BLNON                          $00aa    78D
FNLEN                          $00d1    65D
SA                             $00d3    66D
FA                             $00d4    79D   764    792 
FNADR                          $00da    68D
Link                           $0401   148D
START                          $0401   141D   143    146    146 
Linenumber                     $0403   151D
SysCommand                     $0405   157D
StartML                        $0406   161D
LineEnd                        $0426   164D
EndLink                        $0427   165D   148 
NUMBER                         $042c   169D   269    283    297    304 
                                       306    309    312    378 
UnitText                       $0432   170D   753    753 
DriveText                      $0438   171D   754    754 
Dir_Name                       $043f   172D
Cols                           $0441   173D   546    564 
CursorRow                      $0442   174D   643    652 
CursorCol                      $0443   175D   644    655    664    686 
Entries                        $0444   176D   399    408    488    514 
Pages                          $0445   177D   548    740 
ScreenLo                       $0446   178D   559    563    578    604 
                                       627    654    699 
ScreenHi                       $045f   179D   561    579    607    629 
                                       657    701 
EntryLo                        $0478   180D   453    581    588 
EntryHi                        $04a2   181D   455    584    592 
Page                           $04cc   182D   741    749 
Offset                         $04cd   183D   605    624    697    743 
                                       746    748    752 
Unit                           $04ce   184D   326    516    763    791 
Drive                          $04cf   185D   342    518    798 
LV0                            $04d0   186D   261    270    275    284 
                                       289    298 
LV1                            $04d1   187D   262    266    271    276 
                                       280    285    290    294 
EOD                            $04d2   188D   424    426    787    790 
                                       821    823 
STOP                           $04d4   194D   499 
Error_Beep                     $04d9   201D
PrintText                      $04de   208D
PrTe_10                        $04e4   214D   218 
Flush_Keyboard_Queue           $04ee   222D   226 
FormatByte                     $04f4   230D   327 
asts_01                        $04f9   239D   241 
asts_rt                        $050b   251D   244 
FormatInteger                  $050c   255D   376 
FORINT_01                      $050f   260D   268 
FORINT_02                      $052d   274D   282 
FORINT_03                      $054b   288D   296 
FORINT_04                      $0566   301D   303 
FORINT_05                      $0577   309D   315 
FORINT_06                      $0586   316D   311 
ShowUnit                       $0587   320D   520 
ShUn10                         $059e   334D   329 
ShowDrive                      $05a6   339D   521 
ShowDiskName                   $05b0   349D   522 
FormatFilename                 $05c8   364D   417 
FoFi10                         $05dd   378D   382 
FoFi20                         $05ed   386D   389    391 
FoFi40                         $05fb   393D   398 
FoFi50                         $0600   396D
FoFi99                         $0609   400D   385    395 
FormatEntries                  $060a   404D   523 
FoEn10                         $0617   413D   428 
FoEn20                         $062d   424D   422 
FoEn99                         $0639   429D   416 
PET2SCR                        $063a   433D   463    663    677    684 
                                       772 
P2C10                          $0645   442D   439 
P2C99                          $064f   447D   437    443    445 
ShowEntry                      $0650   450D   480 
ShEn10                         $065c   458D   467 
ShEn20                         $0666   463D   461 
ShEn99                         $0670   468D   459 
ShowEntries                    $0671   472D   524 
ShoE10                         $067b   480D   491 
ShoE20                         $0689   487D   485 
ShoE99                         $0693   492D   489 
MainLoop                       $0694   496D   501    525 
MaLo99                         $069c   502D   500 
Main                           $069d   505D   167 
Main10                         $06d4   528D   530 
EXIT                           $06da   531D
Detect_BASIC_version           $06db   536D   508 
Detect_Screen_Width            $06dc   542D   509 
SetupScreen                    $06e7   553D   510 
SeSe10                         $06ed   559D   569 
SeSe20                         $06fe   567D   565 
SetupEntries                   $0704   574D   511 
SeEn10                         $0706   578D   595 
SeEn20                         $0720   591D   589 
Hor_Line                       $072a   600D   712    714    716 
HoLi10                         $073e   612D   615 
Ver_Line                       $0746   619D   718    720 
VeLi10                         $074e   627D   635 
GotoXY                         $0762   640D   325    354    753    754 
PutChar                        $0769   648D   332    334    336    678 
PutString                      $0789   669D   361    753    754 
PuSt10                         $0799   679D   687 
PuSt99                         $07ac   688D   676    681    683 
PlotAt                         $07ad   691D   345    721    722    723 
                                       724    725    726 
PaintPage                      $07c2   708D   744 
PaintMask                      $0812   730D   512 
PaMa10                         $082f   744D   750 
Get_Disk_Status                $0862   760D   801 
gss_10                         $0871   769D   776 
gss_20                         $0883   777D   771 
Load_Directory                 $0887   782D   519 
LoDi10                         $08ca   812D   817    819 
LoDi20                         $08da   820D   815 
LoDi99                         $08e5   824D   804 
EOP                            $08e6   826D    91    146 
Buffer                         $0900    91D   356    358    359    360 
                                       411    475    477    785    788 
Screen                         $8000    85D   556    557 
Disk_Status                    $8079   190D   773    802 
TALK                           $f0d2    99D   765    805 
LISTEN                         $f0d5   100D   793 
SECOND                         $f143   101D   795 
TKSA                           $f193   102D   767    807 
CIOUT                          $f19e   103D   797    799 
UNTLK                          $f1ae   104D   777    820 
UNLSN                          $f1b9   105D   800 
ACPTR                          $f1c0   106D   769    812 
BSOUT                          $ffd2   107D   205    215    528    734 
                                       736    737 
GETIN                          $ffe4   108D   225 
BP                             $0016    61D   367    369    372y   375y
                                       379y   383y   392y   397y   410 
                                       412    414y   419    421    423 
                                       425    427    458y   476    478 
                                       482    484    486    786    789 
                                       813y   818    822 
SP                             $001b    64D   211    212    214y   454 
                                       456    464y   606    609    612y
                                       628    630    632y   656    659 
                                       662y   685y   700    702    704y
STP                            $0018    62D   368    370    386    387y
                                       396y   672    673    675y   682y
PosDiskName                    $0008    92D   356    358    359    360 
STATUS                         $0096    74D   809    810    814 
FA                             $00d4    79D   764    792 
STKEY                          $009b    75D   196 
CLR                            $0093    20D   735 
LR                             $007d    47D   724 
TR                             $0073    49D   726 
UL                             $0070    44D   721 
UR                             $006e    45D   722 
LL                             $006d    46D   723 
TL                             $006b    48D   725 
VER_BAR                        $005d    43D   631 
HOR_BAR                        $0040    42D   611 
ROWS                           $0019    53D   568 
C8296                          $0000    26D    28 
FNADR                          $00da    68D
SA                             $00d3    66D
FNLEN                          $00d1    65D
BLNON                          $00aa    78D
BLNCT                          $00a8    77D
BLNSW                          $00a7    76D
COLUMNS                        $0050    52D
Tracks                         $004d    55D
TEMP                           $001a    63D
PosDiskID                      $001a    93D
DEL                            $0014    19D
HOME                           $0013    18D
CR                             $000d    17D
BP                             $0016    61D   367    369    372y   375y
                                       379y   383y   392y   397y   410 
                                       412    414y   419    421    423 
                                       425    427    458y   476    478 
                                       482    484    486    786    789 
                                       813y   818    822 
SP                             $001b    64D   211    212    214y   454 
                                       456    464y   606    609    612y
                                       628    630    632y   656    659 
                                       662y   685y   700    702    704y
Buffer                         $0900    91D   356    358    359    360 
                                       411    475    477    785    788 
STP                            $0018    62D   368    370    386    387y
                                       396y   672    673    675y   682y
LV1                            $04d1   187D   262    266    271    276 
                                       280    285    290    294 
NUMBER                         $042c   169D   269    283    297    304 
                                       306    309    312    378 
PlotAt                         $07ad   691D   345    721    722    723 
                                       724    725    726 
Offset                         $04cd   183D   605    624    697    743 
                                       746    748    752 
ScreenLo                       $0446   178D   559    563    578    604 
                                       627    654    699 
EOD                            $04d2   188D   424    426    787    790 
                                       821    823 
LV0                            $04d0   186D   261    270    275    284 
                                       289    298 
ScreenHi                       $045f   179D   561    579    607    629 
                                       657    701 
PET2SCR                        $063a   433D   463    663    677    684 
                                       772 
PutChar                        $0769   648D   332    334    336    678 
GotoXY                         $0762   640D   325    354    753    754 
Unit                           $04ce   184D   326    516    763    791 
Entries                        $0444   176D   399    408    488    514 
CursorCol                      $0443   175D   644    655    664    686 
PosDiskName                    $0008    92D   356    358    359    360 
PuSt99                         $07ac   688D   676    681    683 
PutString                      $0789   669D   361    753    754 
Hor_Line                       $072a   600D   712    714    716 
P2C99                          $064f   447D   437    443    445 
Drive                          $04cf   185D   342    518    798 
EntryHi                        $04a2   181D   455    584    592 
EntryLo                        $0478   180D   453    581    588 
START                          $0401   141D   143    146    146 
STATUS                         $0096    74D   809    810    814 
EOP                            $08e6   826D    91    146 
LoDi10                         $08ca   812D   817    819 
Ver_Line                       $0746   619D   718    720 
MainLoop                       $0694   496D   501    525 
FoFi99                         $0609   400D   385    395 
FoFi20                         $05ed   386D   389    391 
Page                           $04cc   182D   741    749 
Pages                          $0445   177D   548    740 
CursorRow                      $0442   174D   643    652 
Cols                           $0441   173D   546    564 
DriveText                      $0438   171D   754    754 
UnitText                       $0432   170D   753    753 
FA                             $00d4    79D   764    792 
LoDi99                         $08e5   824D   804 
LoDi20                         $08da   820D   815 
Load_Directory                 $0887   782D   519 
gss_20                         $0883   777D   771 
gss_10                         $0871   769D   776 
Get_Disk_Status                $0862   760D   801 
PaMa10                         $082f   744D   750 
PaintMask                      $0812   730D   512 
PaintPage                      $07c2   708D   744 
PuSt10                         $0799   679D   687 
VeLi10                         $074e   627D   635 
HoLi10                         $073e   612D   615 
SeEn20                         $0720   591D   589 
SeEn10                         $0706   578D   595 
SetupEntries                   $0704   574D   511 
SeSe20                         $06fe   567D   565 
SeSe10                         $06ed   559D   569 
SetupScreen                    $06e7   553D   510 
Detect_Screen_Width            $06dc   542D   509 
Detect_BASIC_version           $06db   536D   508 
Main10                         $06d4   528D   530 
Main                           $069d   505D   167 
MaLo99                         $069c   502D   500 
ShoE99                         $0693   492D   489 
ShoE20                         $0689   487D   485 
ShoE10                         $067b   480D   491 
ShowEntries                    $0671   472D   524 
ShEn99                         $0670   468D   459 
ShEn20                         $0666   463D   461 
ShEn10                         $065c   458D   467 
ShowEntry                      $0650   450D   480 
P2C10                          $0645   442D   439 
FoEn99                         $0639   429D   416 
FoEn20                         $062d   424D   422 
FoEn10                         $0617   413D   428 
FormatEntries                  $060a   404D   523 
FoFi40                         $05fb   393D   398 
FoFi10                         $05dd   378D   382 
FormatFilename                 $05c8   364D   417 
ShowDiskName                   $05b0   349D   522 
ShowDrive                      $05a6   339D   521 
ShUn10                         $059e   334D   329 
ShowUnit                       $0587   320D   520 
FORINT_06                      $0586   316D   311 
FORINT_05                      $0577   309D   315 
FORINT_04                      $0566   301D   303 
FORINT_03                      $054b   288D   296 
FORINT_02                      $052d   274D   282 
FORINT_01                      $050f   260D   268 
FormatInteger                  $050c   255D   376 
asts_rt                        $050b   251D   244 
asts_01                        $04f9   239D   241 
FormatByte                     $04f4   230D   327 
Flush_Keyboard_Queue           $04ee   222D   226 
PrTe_10                        $04e4   214D   218 
STOP                           $04d4   194D   499 
EndLink                        $0427   165D   148 
STKEY                          $009b    75D   196 
CLR                            $0093    20D   735 
LR                             $007d    47D   724 
TR                             $0073    49D   726 
UL                             $0070    44D   721 
UR                             $006e    45D   722 
LL                             $006d    46D   723 
TL                             $006b    48D   725 
VER_BAR                        $005d    43D   631 
HOR_BAR                        $0040    42D   611 
ROWS                           $0019    53D   568 
C8296                          $0000    26D    28 
EXIT                           $06da   531D
FoFi50                         $0600   396D
PrintText                      $04de   208D
Error_Beep                     $04d9   201D
Dir_Name                       $043f   172D
LineEnd                        $0426   164D
StartML                        $0406   161D
SysCommand                     $0405   157D
Linenumber                     $0403   151D
Link                           $0401   148D
FNADR                          $00da    68D
SA                             $00d3    66D
FNLEN                          $00d1    65D
BLNON                          $00aa    78D
BLNCT                          $00a8    77D
BLNSW                          $00a7    76D
COLUMNS                        $0050    52D
Tracks                         $004d    55D
TEMP                           $001a    63D
PosDiskID                      $001a    93D
DEL                            $0014    19D
HOME                           $0013    18D
CR                             $000d    17D
